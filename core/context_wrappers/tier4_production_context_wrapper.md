# Tier 4: Production Context Wrapper

> **Who should use this:** Use this wrapper for production-ready applications with paying customers, public-facing services, and systems where reliability and security are critical.

## Overview
A robust context wrapper for production-ready AI applications that demand high reliability and maintainability without the full enterprise compliance overhead of Tier 5.

## Usage Instructions
Embed this block in your AI configuration (e.g., `cursor-config.json → "system"`). It governs all AI-generated commits, pull-requests, and documentation for production deployments.

---

## Cursor LLM Context Rules

### 0 Prime Directive
If a user prompt conflicts with these rules, **pause and request explicit override**. Otherwise, refuse.

---

### 1 Execution Environment
1. **Containerised, rootless builds**  
   * Multi-stage build (Alpine or Debian-slim) producing a minimal runtime image.
   * `USER` non-root; `HEALTHCHECK` included; reproducible `docker buildx` for `linux/amd64`.
2. **Local parity**  
   * All lint, test, and build commands run via `docker compose run …` to avoid drift between dev, CI, and prod.

---

### 2 Supply-Chain Integrity
1. **SLSA 2 provenance** published for every image.  
2. Sign images & commits with **cosign/gitsign**; warn (not block) on unsigned artifacts.  
3. Generate SBOM (`syft`) and fail build on *critical* CVEs; high-severity CVEs trigger warnings.

---

### 3 CI/CD Pipeline
```
lint → test → build → sbom+scan → sign → staging → canary → production
```
* Progressive delivery with manual rollback option.  
* Enforce secret scanning and basic policy checks (e.g., Trivy/Kiara).

---

### 4 Project Layout (Python)
```
app/
  routes/
  services/
  repositories/
  schemas/
  models/
  cli.py
```
* FastAPI async endpoints; business logic isolated from I/O.  
* Environment variables managed via `pydantic_settings`.

---

### 5 Database Discipline
* Alembic migrations required; autogenerated migrations permitted after manual review.  
* CI applies latest migration on a disposable DB and runs smoke tests.

---

### 6 Testing & Quality Gates
* **pytest** ≥ 80 % line coverage & 60 % mutation coverage.  
* `pre-commit`: ruff, black, isort, mypy, bandit, detect-secrets.  
* Contract tests for external APIs; snapshot OpenAPI with warning on diff.

---

### 7 Security & Scanning
* IaC scans on Terraform/Pulumi (severity ≥ high fails build).  
* Weekly DAST scan (OWASP ZAP).  
* Runtime security via Falco or equivalent suggested but not mandatory.

---

### 8 Observability
* Export traces, metrics, and logs with OpenTelemetry if available.  
* `/healthz` and graceful shutdown hooks mandatory.

---

### 9 Documentation & Onboarding
* Docs via MkDocs; CI fails on broken links.  
* ADRs recorded in `docs/adr/`.  
* `codebase_guide.md` updated only on explicit request.

---

### 10 Branch, Commit & Release Hygiene
* Trunk-based with short-lived feature branches; squash merge.  
* Conventional Commits; automated changelog on semver tag.  
* Docker images tagged `v<semver>-<gitsha>`.

---

### 11 LLM-Specific Guard-Rails
1. Never output secrets or personal data.  
2. Cite file paths when referencing code.  
3. Run static analysis and refuse commit on failure.

---

## Implementation Notes
Designed for teams shipping production software at startup-to-mid-market scale. It balances strong engineering discipline with pragmatic speed to market.
